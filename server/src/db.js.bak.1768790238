const fs = require("fs");
const path = require("path");
const sqlite3 = require("sqlite3").verbose();

const DB_PATH =
  process.env.DB_PATH ||
  path.join(__dirname, "..", "r", "data.sqlite");

fs.mkdirSync(path.dirname(DB_PATH), { recursive: true });

const db = new sqlite3.Database(DB_PATH);

function run(sql, params = []) {
  return new Promise((resolve, reject) => {
    db.run(sql, params, function (err) {
      if (err) return reject(err);
      resolve({ lastID: this.lastID, changes: this.changes });
    });
  });
}

function get(sql, params = []) {
  return new Promise((resolve, reject) => {
    db.get(sql, params, (err, row) => {
      if (err) return reject(err);
      resolve(row);
    });
  });
}

function all(sql, params = []) {
  return new Promise((resolve, reject) => {
    db.all(sql, params, (err, rows) => {
      if (err) return reject(err);
      resolve(rows);
    });
  });
}

async function seedTasksIfNeeded() {
  const row = await get("SELECT COUNT(*) AS c FROM tasks");
  const count = row?.c || 0;
  if (count >= 60) return;

  const audio = [
    "https://upload.wikimedia.org/wikipedia/commons/4/4f/En-us-hello.ogg",
    "https://upload.wikimedia.org/wikipedia/commons/1/1c/En-us-good_morning.ogg",
    "https://upload.wikimedia.org/wikipedia/commons/8/8a/En-us-thank_you.ogg",
    "https://upload.wikimedia.org/wikipedia/commons/3/3c/En-us-please.ogg",
  ];

  const video = [
    "https://upload.wikimedia.org/wikipedia/commons/transcoded/7/73/Big_Buck_Bunny_Trailer_1080p.ogv/Big_Buck_Bunny_Trailer_1080p.ogv.360p.webm",
    "https://upload.wikimedia.org/wikipedia/commons/transcoded/3/3f/Elephants_Dream_%282005%29.ogv/Elephants_Dream_%282005%29.ogv.360p.webm",
  ];

  const images = [
    "https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=1200&q=80",
    "https://images.unsplash.com/photo-1522071820081-009f0129c71c?auto=format&fit=crop&w=1200&q=80",
    "https://images.unsplash.com/photo-1553877522-43269d4ea984?auto=format&fit=crop&w=1200&q=80",
    "https://images.unsplash.com/photo-1526378722484-bd91ca387e72?auto=format&fit=crop&w=1200&q=80",
  ];

  // Create ~120 realistic “transcription / captioning” tasks
  const items = [];
  let n = 1;

  for (let i = 0; i < 50; i++) {
    const url = audio[i % audio.length];
    const complexity = (i % 3) + 1; // 1..3
    const reward = 10 + (complexity - 1) * 10; // 10/20/30
    items.push({
      type: "audio_transcription",
      title: `Audio Transcription #${n++}`,
      prompt: "Listen and transcribe the spoken words accurately. Keep punctuation simple. (Short clip)",
      media_url: url,
      image: url,
      complexity,
      reward,
      category: "Transcription",
      description: "Transcribe the audio clip into text."
    });
  }

  for (let i = 0; i < 40; i++) {
    const url = video[i % video.length];
    const complexity = ((i + 1) % 3) + 1;
    const reward = 10 + (complexity - 1) * 10;
    items.push({
      type: "video_captioning",
      title: `Video Captioning #${n++}`,
      prompt: "Watch the short clip and write a 1–2 sentence caption describing what happens.",
      media_url: url,
      image: url,
      complexity,
      reward,
      category: "Captioning",
      description: "Write a short caption summarizing the video."
    });
  }

  for (let i = 0; i < 30; i++) {
    const url = images[i % images.length];
    const complexity = (i % 3) + 1;
    const reward = 10 + (complexity - 1) * 10;
    items.push({
      type: "image_description",
      title: `Image Description #${n++}`,
      prompt: "Describe what you see in the image in 1–2 clear sentences.",
      media_url: url,
      image: url,
      complexity,
      reward,
      category: "Image",
      description: "Describe the image content briefly and clearly."
    });
  }

  for (const t of items) {
    await run(
      `INSERT INTO tasks
        (title, description, category, reward_ksh, image, active, type, prompt, media_url, complexity)
       VALUES
        (?, ?, ?, ?, ?, 1, ?, ?, ?, ?)`,
      [
        t.title,
        t.description,
        t.category,
        t.reward,
        t.image,
        t.type,
        t.prompt,
        t.media_url,
        t.complexity
      ]
    );
  }
}

async function initDb() {
  await run("PRAGMA foreign_keys = ON;");

  await run(`
    CREATE TABLE IF NOT EXISTS users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      username TEXT UNIQUE NOT NULL,
      email TEXT UNIQUE NOT NULL,
      password_hash TEXT NOT NULL,
      referral_code TEXT UNIQUE,
      referred_by INTEGER,
      balance_ksh INTEGER NOT NULL DEFAULT 0,
      bonus_ksh INTEGER NOT NULL DEFAULT 0,
      full_name TEXT,
      phone TEXT,
      payment_number TEXT,
      created_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
      delete_requested_at TEXT,
      delete_effective_at TEXT,
      FOREIGN KEY (referred_by) REFERENCES users(id)
    );
  `);

  await run(`
    CREATE TABLE IF NOT EXISTS tasks (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      title TEXT NOT NULL,
      description TEXT NOT NULL,
      category TEXT NOT NULL,
      reward_ksh INTEGER NOT NULL,
      image TEXT,
      active INTEGER NOT NULL DEFAULT 1,
      type TEXT,
      prompt TEXT,
      media_url TEXT,
      complexity INTEGER NOT NULL DEFAULT 1
    );
  `);

  await run(`
    CREATE TABLE IF NOT EXISTS task_completions (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id INTEGER NOT NULL,
      task_id INTEGER NOT NULL,
      reward_ksh INTEGER NOT NULL,
      created_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (user_id) REFERENCES users(id),
      FOREIGN KEY (task_id) REFERENCES tasks(id)
    );
  `);

  await run(`
    CREATE TABLE IF NOT EXISTS withdrawals (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id INTEGER NOT NULL,
      amount_ksh INTEGER NOT NULL,
      phone_number TEXT NOT NULL,
      method TEXT NOT NULL,
      status TEXT NOT NULL DEFAULT "pending",
      created_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (user_id) REFERENCES users(id)
    );
  `);

  // Seed tasks after schema exists
  await seedTasksIfNeeded();
}

module.exports = { db, run, get, all, initDb };
